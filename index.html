<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divisions Escolars - Final</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 950px; text-align: center; }
        
        /* CONFIGURACI√ì */
        .config-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 30px;
        }
        .config-group { display: flex; flex-direction: column; align-items: center; }
        .config-group h3 { margin: 0 0 10px 0; font-size: 1rem; color: #555; text-transform: uppercase; letter-spacing: 1px; }
        .input-row { display: flex; gap: 10px; align-items: center; }
        .input-group { display: flex; flex-direction: column; align-items: center; }
        .input-group label { font-size: 0.9rem; color: #777; margin-bottom: 4px; font-weight: 500; }
        .input-mini { 
            width: 70px; 
            font-size: 1.1rem; 
            padding: 5px; 
            border: 1px solid #bdc3c7; 
            border-radius: 6px; 
            text-align: center; 
        }

        /* OPERACI√ì */
        .horizontal-box { font-size: 2.2rem; margin-bottom: 25px; padding: 25px; background: #fff4e6; border-radius: 12px; border: 2px solid #e67e22; display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap;}
        #user-ans { width: 180px; font-size: 2rem; padding: 8px; border: 2px solid #bdc3c7; border-radius: 8px; text-align: center; }
        .operator { color: #e67e22; font-weight: bold; }

        /* BOTONS */
        .btn-main { padding: 15px 30px; font-size: 1.2rem; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; margin: 5px; color: white; transition: 0.2s; }
        .btn-check { background: #e67e22; }
        .btn-next { background: #2ecc71; }
        .btn-main:hover { opacity: 0.9; transform: translateY(-2px); }

        .feedback { margin: 20px; font-size: 1.4rem; font-weight: bold; min-height: 1.5em; }
        .hidden { display: none !important; }

        /* SOLUCIONARI */
        .solutions-wrapper {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
            text-align: left;
        }
        .solution-col {
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            min-width: 300px;
        }
        .sol-title { text-align: center; font-weight: bold; color: #555; margin-bottom: 10px; text-transform: uppercase; font-size: 0.9rem; }
        
        .div-grid {
            display: grid;
            font-family: 'Courier New', monospace;
            font-size: 1.8rem;
            line-height: 1.8rem;
            font-weight: bold;
            justify-content: center;
        }
        .c { width: 25px; text-align: center; height: 32px; }
        
        .border-left { border-left: 2px solid #333; }
        .border-bottom { border-bottom: 2px solid #333; }
        
        .quotient-res { color: #2980b9; }
        .faded { color: #ccc; } 

    </style>
</head>
<body>

<div class="card">
    <h1>Practicar Divisions</h1>
    
    <div class="config-panel">
        <div class="config-group">
            <h3>Dividend (N√∫mero a dividir)</h3>
            <div class="input-row">
                <div class="input-group">
                    <label>Part entera</label>
                    <input type="number" id="d-int" class="input-mini" value="3" min="1" max="6">
                </div>
                <div class="input-group">
                    <label>Decimals</label>
                    <input type="number" id="d-dec" class="input-mini" value="0" min="0" max="4">
                </div>
            </div>
        </div>

        <div class="config-group">
            <h3>Divisor</h3>
            <div class="input-row">
                <div class="input-group">
                    <label>Part entera</label>
                    <input type="number" id="div-int" class="input-mini" value="1" min="1" max="3">
                </div>
            </div>
        </div>
    </div>

    <div class="horizontal-box">
        <span id="q-dividend">0</span> 
        <span class="operator">√∑</span> 
        <span id="q-divisor">0</span> 
        <span>=</span>
        <input type="text" id="user-ans" autocomplete="off" placeholder="Quocient">
    </div>

    <button type="button" class="btn-main btn-check" onclick="check()">Comprova</button>
    <button type="button" class="btn-main btn-next" onclick="generate()">Nova Operaci√≥</button>

    <div id="msg" class="feedback"></div>

    <div id="sol-box" class="hidden">
        <hr>
        <div class="solutions-wrapper">
            <div class="solution-col">
                <div class="sol-title">M√®tode Directe (Mental)</div>
                <div id="grid-direct" class="div-grid"></div>
            </div>
            <div class="solution-col">
                <div class="sol-title">M√®tode amb Resta</div>
                <div id="grid-sub" class="div-grid"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Variables globals
    let dividendNum = 0;
    let divisorNum = 1;

    // --- GENERACI√ì DE N√öMEROS ---
    function generateRandomByDigits(intDigits, decDigits) {
        if (!intDigits || intDigits < 1) intDigits = 1;
        if (!decDigits || decDigits < 0) decDigits = 0;

        const minInt = Math.pow(10, intDigits - 1);
        const maxInt = Math.pow(10, intDigits) - 1;
        const integerPart = Math.floor(Math.random() * (maxInt - minInt + 1)) + minInt;

        if (decDigits === 0) return integerPart;

        let decimalStr = "";
        for (let i = 0; i < decDigits; i++) {
            if (i === decDigits - 1) {
                // Evitem que l'√∫ltim decimal siga 0 per no perdre longitud visual
                decimalStr += Math.floor(Math.random() * 9) + 1; 
            } else {
                decimalStr += Math.floor(Math.random() * 10);
            }
        }
        return parseFloat(`${integerPart}.${decimalStr}`);
    }

    // --- FUNCI√ì PRINCIPAL: GENERAR OPERACI√ì ---
    function generate() {
        try {
            const dIntInput = document.getElementById('d-int');
            const dDecInput = document.getElementById('d-dec');
            const divIntInput = document.getElementById('div-int');

            const cfgDividendInt = dIntInput ? (parseInt(dIntInput.value) || 3) : 3;
            const cfgDividendDec = dDecInput ? (parseInt(dDecInput.value) || 0) : 0;
            const cfgDivisorInt = divIntInput ? (parseInt(divIntInput.value) || 1) : 1;

            dividendNum = generateRandomByDigits(cfgDividendInt, cfgDividendDec);
            
            do {
                divisorNum = generateRandomByDigits(cfgDivisorInt, 0);
            } while (divisorNum === 0);

            document.getElementById('q-dividend').innerText = dividendNum.toString().replace('.', ',');
            document.getElementById('q-divisor').innerText = divisorNum;
            
            const userAns = document.getElementById('user-ans');
            userAns.value = '';
            document.getElementById('msg').innerText = '';
            document.getElementById('sol-box').classList.add('hidden');
            userAns.focus();
        } catch(e) {
            console.error("Error generant:", e);
        }
    }

    // --- FUNCI√ì COMPROVAR ---
    function check() {
        try {
            const userEl = document.getElementById('user-ans');
            const userStr = userEl.value.replace(',', '.');
            const userVal = parseFloat(userStr);
            
            const sim = simulateDivision(dividendNum, divisorNum); 
            const correctVal = parseFloat(sim.quotientStr);

            const msg = document.getElementById('msg');
            
            if (!isNaN(userVal) && Math.abs(userVal - correctVal) < 0.0000001) {
                msg.innerText = "¬°Excel¬∑lent! Resposta correcta. üéâ";
                msg.style.color = "#2ecc71";
            } else {
                msg.innerHTML = `Incorrecte. El resultat √©s <span>${sim.quotientStr.replace('.', ',')}</span>`;
                msg.style.color = "#e74c3c";
            }

            renderDivision('grid-direct', dividendNum, divisorNum, false);
            renderDivision('grid-sub', dividendNum, divisorNum, true);
            document.getElementById('sol-box').classList.remove('hidden');
        } catch(e) {
            console.error("Error comprovant:", e);
        }
    }

    // --- MOTOR MATEM√ÄTIC DE LA DIVISI√ì ---
    function simulateDivision(dividend, divisor) {
        const divStrFull = dividend.toString();
        let digits = [];
        let decimalPos = -1;

        // Convertir a array de d√≠gits i detectar coma
        for (let i = 0; i < divStrFull.length; i++) {
            if (divStrFull[i] === '.') {
                decimalPos = i; 
            } else {
                digits.push(parseInt(divStrFull[i]));
            }
        }

        let steps = [];
        let quotientStr = "";
        let pointer = 0;
        let currentVal = digits[0]; 

        // -- PAS PREVI: AGRUPAMENT INICIAL --
        // Si el primer d√≠git √©s menor que el divisor i tenim m√©s n√∫meros abans de la coma,
        // agafem dos d√≠gits d'entrada.
        const digitsBeforeDecimal = (decimalPos === -1) ? digits.length : decimalPos;
        
        if (currentVal < divisor && digitsBeforeDecimal > 1) {
            pointer++;
            currentVal = (currentVal * 10) + digits[pointer];
        }

        // -- BUCLE PRINCIPAL --
        while (pointer < digits.length) {
            
            // C√†lcul
            let qDigit = Math.floor(currentVal / divisor);
            let product = qDigit * divisor;
            let remainder = currentVal - product;

            steps.push({
                currentVal: currentVal,
                qDigit: qDigit,
                product: product,
                remainder: remainder,
                colIndex: pointer
            });

            quotientStr += qDigit;

            // Preparar seg√ºent pas
            pointer++;
            
            // Comprovar si hem de posar coma AL QUOCIENT
            // Si hem passat la posici√≥ decimal original
            if (decimalPos !== -1 && pointer === decimalPos) {
                 if (quotientStr === "") quotientStr += "0";
                 if (!quotientStr.includes('.')) quotientStr += ".";
            }

            // Si ja no queden d√≠gits, acabem
            if (pointer >= digits.length) break;

            // Baixar seg√ºent xifra
            let nextDigit = digits[pointer];
            
            // Guardar quina xifra baixa per dibuixar-la despr√©s
            steps[steps.length - 1].droppedDigit = nextDigit;

            currentVal = (remainder * 10) + nextDigit;
        }

        // Neteja final (treure 0 a l'esquerra si no √©s 0.xx)
        if (quotientStr.length > 1 && quotientStr.startsWith('0') && quotientStr[1] !== '.') {
            quotientStr = quotientStr.substring(1);
        }

        return { quotientStr, steps, digits, decimalPos };
    }

    // --- MOTOR DE DIBUIX (GRAELLA) ---
    function renderDivision(containerId, dividend, divisor, showSubtraction) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        
        const sim = simulateDivision(dividend, divisor);
        const divStr = dividend.toString().replace('.', ',');
        const divisorStr = divisor.toString();
        
        const totalCols = divStr.length + 1 + divisorStr.length; 
        container.style.gridTemplateColumns = `repeat(${totalCols}, 25px)`;

        // Buffer per guardar les cel¬∑les
        let rows = [];
        function setCell(r, c, text, classes=[]) {
            if (!rows[r]) rows[r] = [];
            rows[r][c] = { text, classes };
        }

        // --- FILA 0: ENUNCIAT ---
        let col = 0;
        for (let char of divStr) { setCell(0, col++, char); }
        setCell(0, col, "", ['border-left', 'border-bottom']);
        let sepCol = col;
        col++;
        for (let char of divisorStr) { setCell(0, col++, char, ['border-bottom']); }
        
        // --- FILA 1: QUOCIENT ---
        let qStrFormatted = sim.quotientStr.replace('.', ',');
        col = sepCol + 1;
        for (let char of qStrFormatted) {
            setCell(1, col++, char, ['quotient-res']);
        }

        // --- MAPEJAT DE COLUMNES ---
        let mapDigitIndexToCol = [];
        let currentStringIdx = 0;
        for (let i=0; i<sim.digits.length; i++) {
            if (divStr[currentStringIdx] === ',') currentStringIdx++; 
            mapDigitIndexToCol[i] = currentStringIdx;
            currentStringIdx++;
        }

        let currentRow = 1;

        sim.steps.forEach((step, idx) => {
            const colIdx = mapDigitIndexToCol[step.colIndex];

            // Si el quocient √©s 0, no dibuixem resta ni residu nou,
            // nom√©s baixem la seg√ºent xifra al costat de l'actual.
            if (step.qDigit === 0) {
                if (step.droppedDigit !== undefined) {
                    let nextCol = mapDigitIndexToCol[step.colIndex + 1];
                    // Pintem a la fila actual
                    setCell(currentRow, nextCol, step.droppedDigit);
                }
                return; 
            }

            if (showSubtraction) {
                if (idx > 0) currentRow++; 

                // Resta
                const prodStr = step.product.toString();
                let startCol = colIdx - prodStr.length + 1;
                for (let i=0; i<prodStr.length; i++) {
                    setCell(currentRow, startCol + i, prodStr[i], ['faded', 'border-bottom']); 
                }
                
                currentRow++;

                // Residu
                const remStr = step.remainder.toString();
                startCol = colIdx - remStr.length + 1;
                for (let i=0; i<remStr.length; i++) {
                    setCell(currentRow, startCol + i, remStr[i]);
                }
                
                // Baixar xifra
                if (step.droppedDigit !== undefined) {
                    let nextCol = mapDigitIndexToCol[step.colIndex + 1];
                    setCell(currentRow, nextCol, step.droppedDigit);
                }

            } else {
                // Directe
                if (idx > 0) currentRow++;
                
                const remStr = step.remainder.toString();
                let startCol = colIdx - remStr.length + 1;
                for (let i=0; i<remStr.length; i++) {
                    setCell(currentRow, startCol + i, remStr[i]);
                }

                if (step.droppedDigit !== undefined) {
                    let nextCol = mapDigitIndexToCol[step.colIndex + 1];
                    setCell(currentRow, nextCol, step.droppedDigit);
                }
            }
        });

        // --- CONVERTIR A DOM ---
        const maxR = rows.length;
        container.style.gridTemplateRows = `repeat(${maxR}, 32px)`;

        for (let r = 0; r < maxR; r++) {
            for (let c = 0; c < totalCols; c++) {
                const cellData = (rows[r] && rows[r][c]) ? rows[r][c] : { text: '', classes: [] };
                const div = document.createElement('div');
                div.className = 'c';
                div.innerText = cellData.text;
                if (cellData.classes.length > 0) div.classList.add(...cellData.classes);
                div.style.gridRowStart = r + 1;
                div.style.gridColumnStart = c + 1;
                container.appendChild(div);
            }
        }
    }

    // Inicialitzaci√≥ al carregar
    window.onload = generate;
    
    // Suport per Enter
    document.querySelectorAll('.input-mini').forEach(input => {
        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') generate();
        });
    });

</script>
</body>
</html>