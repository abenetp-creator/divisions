<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divisions Escolars - Final</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 950px; text-align: center; }
        
        /* CONFIGURACI */
        .config-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 30px;
        }
        .config-group { display: flex; flex-direction: column; align-items: center; }
        .config-group h3 { margin: 0 0 10px 0; font-size: 1rem; color: #555; text-transform: uppercase; letter-spacing: 1px; }
        .input-row { display: flex; gap: 10px; align-items: center; }
        .input-group { display: flex; flex-direction: column; align-items: center; }
        .input-group label { font-size: 0.9rem; color: #777; margin-bottom: 4px; font-weight: 500; }
        .input-mini { 
            width: 70px; 
            font-size: 1.1rem; 
            padding: 5px; 
            border: 1px solid #bdc3c7; 
            border-radius: 6px; 
            text-align: center; 
        }

        /* OPERACI */
        .horizontal-box { font-size: 2.2rem; margin-bottom: 25px; padding: 25px; background: #fff4e6; border-radius: 12px; border: 2px solid #e67e22; display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap;}
        #user-ans { width: 180px; font-size: 2rem; padding: 8px; border: 2px solid #bdc3c7; border-radius: 8px; text-align: center; }
        .operator { color: #e67e22; font-weight: bold; }

        /* BOTONS */
        .btn-main { padding: 15px 30px; font-size: 1.2rem; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; margin: 5px; color: white; transition: 0.2s; }
        .btn-check { background: #e67e22; }
        .btn-next { background: #2ecc71; }
        .btn-main:hover { opacity: 0.9; transform: translateY(-2px); }

        .feedback { margin: 20px; font-size: 1.4rem; font-weight: bold; min-height: 1.5em; }
        .hidden { display: none !important; }

        /* SOLUCIONARI */
        .solutions-wrapper {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
            text-align: left;
        }
        .solution-col {
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            min-width: 300px;
        }
        .sol-title { text-align: center; font-weight: bold; color: #555; margin-bottom: 10px; text-transform: uppercase; font-size: 0.9rem; }
        
        .div-grid {
            display: grid;
            font-family: 'Courier New', monospace;
            font-size: 1.8rem;
            line-height: 1.8rem;
            font-weight: bold;
            justify-content: center;
        }
        .c { width: 25px; text-align: center; height: 32px; }
        
        .border-left { border-left: 2px solid #333; }
        .border-bottom { border-bottom: 2px solid #333; }
        
        .quotient-res { color: #2980b9; }
        .faded { color: #ccc; } 

    </style>
</head>
<body>

<div class="card">
    <h1>Practicar Divisions</h1>
    
    <div class="config-panel">
        <div class="config-group">
            <h3>Dividend (N煤mero a dividir)</h3>
            <div class="input-row">
                <div class="input-group">
                    <label>Part entera</label>
                    <input type="number" id="d-int" class="input-mini" value="3" min="1" max="6">
                </div>
                <div class="input-group">
                    <label>Decimals</label>
                    <input type="number" id="d-dec" class="input-mini" value="0" min="0" max="4">
                </div>
            </div>
        </div>

        <div class="config-group">
            <h3>Divisor</h3>
            <div class="input-row">
                <div class="input-group">
                    <label>Part entera</label>
                    <input type="number" id="div-int" class="input-mini" value="1" min="1" max="3">
                </div>
            </div>
        </div>
    </div>

    <div class="horizontal-box">
        <span id="q-dividend">...</span> 
        <span class="operator">梅</span> 
        <span id="q-divisor">...</span> 
        <span>=</span>
        <input type="text" id="user-ans" autocomplete="off" placeholder="?">
    </div>

    <button type="button" class="btn-main btn-check" onclick="comprovarResultat()">Comprova</button>
    <button type="button" class="btn-main btn-next" onclick="nouExercici()">Nova Operaci贸</button>

    <div id="msg" class="feedback"></div>

    <div id="sol-box" class="hidden">
        <hr>
        <div class="solutions-wrapper">
            <div class="solution-col">
                <div class="sol-title">M猫tode Directe (Mental)</div>
                <div id="grid-direct" class="div-grid"></div>
            </div>
            <div class="solution-col">
                <div class="sol-title">M猫tode amb Resta</div>
                <div id="grid-sub" class="div-grid"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Variables globals
    let dividendNum = 0;
    let divisorNum = 1;

    // Funci贸 auxiliar per generar n煤meros
    function generateRandomByDigits(intDigits, decDigits) {
        // Valors per defecte si falla l'input
        if (!intDigits || isNaN(intDigits) || intDigits < 1) intDigits = 1;
        if (!decDigits || isNaN(decDigits) || decDigits < 0) decDigits = 0;

        const minInt = Math.pow(10, intDigits - 1);
        const maxInt = Math.pow(10, intDigits) - 1;
        const integerPart = Math.floor(Math.random() * (maxInt - minInt + 1)) + minInt;

        if (decDigits === 0) return integerPart;

        let decimalStr = "";
        for (let i = 0; i < decDigits; i++) {
            if (i === decDigits - 1) {
                decimalStr += Math.floor(Math.random() * 9) + 1; 
            } else {
                decimalStr += Math.floor(Math.random() * 10);
            }
        }
        return parseFloat(`${integerPart}.${decimalStr}`);
    }

    // Funci贸 principal per generar la divisi贸
    function nouExercici() {
        console.log("Generant nova operaci贸...");
        
        // Obtenir valors dels inputs amb protecci贸
        const dIntEl = document.getElementById('d-int');
        const dDecEl = document.getElementById('d-dec');
        const divIntEl = document.getElementById('div-int');

        const cfgDividendInt = dIntEl ? parseInt(dIntEl.value) : 3;
        const cfgDividendDec = dDecEl ? parseInt(dDecEl.value) : 0;
        const cfgDivisorInt = divIntEl ? parseInt(divIntEl.value) : 1;

        // Generar n煤meros
        dividendNum = generateRandomByDigits(cfgDividendInt, cfgDividendDec);
        
        do {
            divisorNum = generateRandomByDigits(cfgDivisorInt, 0);
        } while (divisorNum === 0);

        // Actualitzar pantalla
        const divLabel = document.getElementById('q-dividend');
        const divisorLabel = document.getElementById('q-divisor');
        const userInput = document.getElementById('user-ans');
        const msg = document.getElementById('msg');
        const solBox = document.getElementById('sol-box');

        if(divLabel) divLabel.innerText = dividendNum.toString().replace('.', ',');
        if(divisorLabel) divisorLabel.innerText = divisorNum;
        
        if(userInput) {
            userInput.value = '';
            userInput.focus();
        }
        if(msg) msg.innerText = '';
        if(solBox) solBox.classList.add('hidden');
    }

    // Funci贸 per comprovar
    function comprovarResultat() {
        const userEl = document.getElementById('user-ans');
        if (!userEl) return;

        const userStr = userEl.value.replace(',', '.');
        const userVal = parseFloat(userStr);
        
        const sim = simulateDivision(dividendNum, divisorNum); 
        const correctVal = parseFloat(sim.quotientStr);

        const msg = document.getElementById('msg');
        
        if (!isNaN(userVal) && Math.abs(userVal - correctVal) < 0.0000001) {
            msg.innerText = "隆Excel路lent! Resposta correcta. ";
            msg.style.color = "#2ecc71";
        } else {
            msg.innerHTML = `Incorrecte.`;
            msg.style.color = "#e74c3c";
        }

        renderDivision('grid-direct', dividendNum, divisorNum, false);
        renderDivision('grid-sub', dividendNum, divisorNum, true);
        document.getElementById('sol-box').classList.remove('hidden');
    }

    // L貌gica matemtica de la divisi贸
    function simulateDivision(dividend, divisor) {
        const divStr = dividend.toString();
        let digits = [];
        let decimalPos = -1;

        for (let i = 0; i < divStr.length; i++) {
            if (divStr[i] === '.') {
                decimalPos = i; 
            } else {
                digits.push(parseInt(divStr[i]));
            }
        }

        let currentVal = 0;
        let quotientStr = "";
        let steps = []; 

        let pointer = 0;

        while (pointer < digits.length) {
            let digit = digits[pointer];
            
            if (decimalPos !== -1 && pointer === (decimalPos)) {
                 if (quotientStr === "") quotientStr += "0";
                 if (!quotientStr.includes('.')) quotientStr += ".";
            }
            
            currentVal = (currentVal * 10) + digit;
            
            let qDigit = Math.floor(currentVal / divisor);
            let product = qDigit * divisor;
            let remainder = currentVal - product;

            steps.push({
                currentVal: currentVal,
                qDigit: qDigit,
                product: product,
                remainder: remainder,
                droppedDigit: digit,
                colIndex: pointer
            });

            quotientStr += qDigit;
            currentVal = remainder;
            pointer++;
        }

        if (quotientStr.startsWith("0") && quotientStr[1] !== "." && quotientStr.length > 1) {
            quotientStr = quotientStr.replace(/^0+/, '');
        }

        return { quotientStr, steps, digits, decimalPos };
    }

    // Dibuixar la graella
    function renderDivision(containerId, dividend, divisor, showSubtraction) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        
        const sim = simulateDivision(dividend, divisor);
        const divStr = dividend.toString().replace('.', ',');
        const divisorStr = divisor.toString();
        
        const totalCols = divStr.length + 1 + divisorStr.length; 
        
        container.style.gridTemplateColumns = `repeat(${totalCols}, 25px)`;

        // --- BUFFER GRID ---
        let rows = [];
        function setCell(r, c, text, classes=[]) {
            if (!rows[r]) rows[r] = [];
            rows[r][c] = { text, classes };
        }

        // CAPALERA
        let col = 0;
        for (let char of divStr) { setCell(0, col++, char); }
        setCell(0, col, "", ['border-left', 'border-bottom']);
        let sepCol = col;
        col++;
        for (let char of divisorStr) { setCell(0, col++, char, ['border-bottom']); }
        
        // QUOCIENT
        let qStrFormatted = sim.quotientStr.replace('.', ',');
        col = sepCol + 1;
        for (let char of qStrFormatted) {
            setCell(1, col++, char, ['quotient-res']);
        }

        // PASSOS
        let mapDigitIndexToCol = [];
        let currentStringIdx = 0;
        for (let i=0; i<sim.digits.length; i++) {
            if (divStr[currentStringIdx] === ',') currentStringIdx++; 
            mapDigitIndexToCol[i] = currentStringIdx;
            currentStringIdx++;
        }

        let currentRow = 1;

        sim.steps.forEach((step, idx) => {
            const colIdx = mapDigitIndexToCol[step.colIndex];

            // SI EL QUOCIENT S 0: No baixem fila, nom茅s posem la seg眉ent xifra al costat
            if (step.qDigit === 0) {
                if (idx < sim.steps.length - 1) {
                    const nextStep = sim.steps[idx+1];
                    const nextDigit = nextStep.droppedDigit;
                    const nextDigitCol = mapDigitIndexToCol[nextStep.colIndex];
                    setCell(currentRow, nextDigitCol, nextDigit);
                }
                return; 
            }

            if (showSubtraction) {
                if (idx > 0) currentRow++;

                // Resta
                const prodStr = step.product.toString();
                let startCol = colIdx - prodStr.length + 1;
                for (let i=0; i<prodStr.length; i++) {
                    setCell(currentRow, startCol + i, prodStr[i], ['faded', 'border-bottom']); 
                }
                
                currentRow++;

                // Residu
                const remStr = step.remainder.toString();
                startCol = colIdx - remStr.length + 1;
                for (let i=0; i<remStr.length; i++) {
                    setCell(currentRow, startCol + i, remStr[i]);
                }
                
                // Baixar xifra
                if (idx < sim.steps.length - 1) {
                    const nextStep = sim.steps[idx+1];
                    const nextDigit = nextStep.droppedDigit;
                    const nextDigitCol = mapDigitIndexToCol[nextStep.colIndex];
                    setCell(currentRow, nextDigitCol, nextDigit);
                }

            } else {
                // Directe
                if (idx > 0) currentRow++;
                
                const remStr = step.remainder.toString();
                let startCol = colIdx - remStr.length + 1;
                for (let i=0; i<remStr.length; i++) {
                    setCell(currentRow, startCol + i, remStr[i]);
                }

                if (idx < sim.steps.length - 1) {
                    const nextStep = sim.steps[idx+1];
                    const nextDigit = nextStep.droppedDigit;
                    const nextDigitCol = mapDigitIndexToCol[nextStep.colIndex];
                    setCell(currentRow, nextDigitCol, nextDigit);
                }
            }
        });

        // RENDER AL DOM
        const maxR = rows.length;
        container.style.gridTemplateRows = `repeat(${maxR}, 32px)`;

        for (let r = 0; r < maxR; r++) {
            for (let c = 0; c < totalCols; c++) {
                const cellData = (rows[r] && rows[r][c]) ? rows[r][c] : { text: '', classes: [] };
                const div = document.createElement('div');
                div.className = 'c';
                div.innerText = cellData.text;
                if (cellData.classes.length > 0) div.classList.add(...cellData.classes);
                div.style.gridRowStart = r + 1;
                div.style.gridColumnStart = c + 1;
                container.appendChild(div);
            }
        }
    }

    // Inicialitzaci贸 segura
    document.addEventListener('DOMContentLoaded', () => {
        nouExercici();
        
        // Tecla Enter
        document.querySelectorAll('.input-mini').forEach(input => {
            input.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') nouExercici();
            });
        });
    });

</script>
</body>
</html>